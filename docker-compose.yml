version: '2'
volumes:
  openhab-addons:
  openhab-conf:
  openhab-userdata:
  openhab-startup-scripts:
  influxdb:
  grafana:

networks:
  raspberrypi_overlay:

services:
  samba:
    image: dperson/samba:armhf
    ports:
      - "139:139"
      - "445:445"
    networks:
      - raspberrypi_overlay
    volumes:
      - openhab-addons:/mount/openhab-addons
      - openhab-conf:/mount/openhab-conf
      - openhab-startup-scripts:/mount/openhab-startup-scripts
      - openhab-userdata:/mount/openhab-userdata
      - grafana:/mount/grafana
      - influxdb:/mount/influxdb
    restart: unless-stopped
    environment:
      USER: openhab;$AUTH_SMB_PASSWORD
      SHARE: raspberry-share;/mount;yes;no;no;all
      USERID: 0
      GROUPID: 0

  traefik:
    image: traefik:latest
    ports:
      - "80:80"
      - "8080:8080"
    command: ['--api.insecure=true', '--api.dashboard=true', '--providers.docker', '--providers.docker.endpoint=unix:///var/run/balena.sock', '--entryPoints.web.address=:80', '--providers.docker.exposedbydefault=false', '--providers.docker.network=raspberrypi_overlay']
    networks:
      - raspberrypi_overlay
    restart: unless-stopped
    labels:
      io.balena.features.balena-socket: true

  openhab:
    build: ./openhab
    networks:
      - raspberrypi_overlay
    restart: unless-stopped
    expose:
      - "8080"
    devices:
      - "/dev/ttyACM0:/dev/ttyACM0"
    volumes:
      - openhab-addons:/openhab/addons
      - openhab-conf:/openhab/conf
      - openhab-startup-scripts:/etc/cont-init.d
      - openhab-userdata:/openhab/userdata
    labels:
      traefik.backend: openhab
      traefik.docker.network: raspberrypi_overlay
      traefik.enable: true
      traefik.http.middlewares.openhab-auth.basicauth.users: openhab:$AUTH_OPENHAB_PASSWORD
      traefik.http.routers.openhab-router.middlewares: openhab-auth
      traefik.http.routers.openhab-router.rule: PathPrefix(`/`)
      traefik.http.routers.traefik-router.entrypoints: web
      traefik.http.services.openhab-service.loadbalancer.server.port: 8080
    environment:
      OHC_UUID: $AUTH_OPENHAB_UUID
      OHC_SECRET: $AUTH_OPENHAB_SECRET

  influxdb:
    image: influxdb:latest
    networks:
      - raspberrypi_overlay
    restart: unless-stopped
    volumes:
      - influxdb:/var/lib/influxdb
    environment:
      INFLUXDB_DB: openhab
      INFLUXDB_USER: openhab
      INFLUXDB_USER_PASSWORD: $AUTH_INFLUXDB_PASSWORD
      INFLUXDB_LOG_LEVEL: error
      INFLUXDB_DATA_QUERY_LOG_ENABLED: 'true'
      INFLUXDB_REPORTING_DISABLED: 'false'
      INFLUXDB_HTTP_LOG_ENABLED: 'false'
      INFLUXDB_META_LOGGING_ENABLED: 'false'

  grafana:
    image: grafana/grafana:latest
    networks:
      - raspberrypi_overlay
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - grafana:/var/lib/grafana
    environment:
      GF_SECURITY_ADMIN_USER: openhab
      GF_SECURITY_ADMIN_PASSWORD: $AUTH_GRAFANA_PASSWORD

  watchtower:
    image: containrrr/watchtower
    networks:
      - raspberrypi_overlay
    restart: unless-stopped
    labels:
      io.balena.features.balena-socket: true
    environment:
      WATCHTOWER_SCHEDULE: 0 0 4 ? * 6
      WATCHTOWER_CLEANUP: 'true'
      DOCKER_HOST: unix:///var/run/balena.sock

  bluetooth-beacon:
    image: dominikth/rpi-docker-ibeacon:latest
    network_mode: host
    restart: unless-stopped
    environment:
      UUID: 88BCBF76-F2B4-4BB0-A982-906C16121FF7
      MINOR: 0
      MAJOR: 0
